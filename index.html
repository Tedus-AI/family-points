<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭點數紀錄器(雲端版)</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>

    <!-- [FIX] 預先定義 dbService 避免 React 報錯 -->
    <script>
        window.dbService = {
            isReady: false,
            subscribeRecords: () => () => {},
            subscribeTags: () => () => {},
            addRecord: async () => {},
            deleteRecord: async () => {},
            addTag: async () => {},
            deleteTag: async () => {},
            seedTags: async () => {}
        };
    </script>
</head>
<body class="bg-slate-100 pb-24">
    <div id="root"></div>

    <!-- 這是 Firebase 的 SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // ▼▼▼ 您的 Firebase 設定 ▼▼▼
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyC4b1921SqNxC-qqKr_lupUhSE6hBA8Zc0",
          authDomain: "bad-habits-academic-rewards.firebaseapp.com",
          projectId: "bad-habits-academic-rewards",
          storageBucket: "bad-habits-academic-rewards.firebasestorage.app",
          messagingSenderId: "871238068477",
          appId: "1:871238068477:web:98f7e1da3341197b9bf694",
          measurementId: "G-88E5VPZR6H"
        };
        // ==========================================
        // ▲▲▲ 設定結束 ▲▲▲
        // ==========================================

        let db = null;
        let isFirebaseReady = false;

        if (firebaseConfig.projectId) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
                console.log("Firebase connected successfully!");
            } catch (e) {
                console.error("Firebase init error:", e);
            }
        }

        // 覆寫 window.dbService 為真實的 Firebase 服務
        window.dbService = {
            isReady: isFirebaseReady,
            
            // 監聽紀錄 (Records)
            subscribeRecords: (callback) => {
                if (!isFirebaseReady) return () => {};
                const q = query(collection(db, "records"), orderBy("createdAt", "desc"));
                return onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestampStr: doc.data().createdAt?.toDate().toLocaleString('zh-TW', {
                            month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        }) || '剛剛'
                    }));
                    callback(data);
                });
            },

            // 監聽標籤 (Tags)
            subscribeTags: (callback) => {
                if (!isFirebaseReady) return () => {};
                // 標籤依建立時間排序，這樣新加的會在後面
                const q = query(collection(db, "tags"), orderBy("createdAt", "asc"));
                return onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    callback(data);
                });
            },

            // 新增紀錄
            addRecord: async (record) => {
                if (!isFirebaseReady) return;
                try {
                    await addDoc(collection(db, "records"), {
                        ...record,
                        createdAt: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Add Record Error", e);
                    alert("新增紀錄失敗");
                }
            },

            // 刪除紀錄
            deleteRecord: async (id) => {
                if (!isFirebaseReady) return;
                if (window.confirm('確定要撤銷這條紀錄嗎？（分數會恢復）')) {
                    try {
                        await deleteDoc(doc(db, "records", id));
                    } catch (e) { console.error(e); }
                }
            },

            // 新增標籤
            addTag: async (tag) => {
                if (!isFirebaseReady) return;
                try {
                    await addDoc(collection(db, "tags"), {
                        ...tag,
                        createdAt: serverTimestamp()
                    });
                } catch (e) { console.error(e); }
            },

            // 刪除標籤
            deleteTag: async (id) => {
                if (!isFirebaseReady) return;
                if (window.confirm('確定要從快速選單移除這個選項嗎？(不會影響已記下的分數)')) {
                    try {
                        await deleteDoc(doc(db, "tags", id));
                    } catch (e) { console.error(e); }
                }
            },
            
            // 初始化預設標籤 (如果資料庫是空的)
            seedTags: async (presets) => {
                if (!isFirebaseReady) return;
                const tagsRef = collection(db, "tags");
                // 簡單檢查是否有任何 tag，如果完全沒有才寫入預設值
                const snapshot = await getDocs(tagsRef);
                if (snapshot.empty) {
                    console.log("Seeding default tags...");
                    const batchPromises = presets.map(tag => addDoc(tagsRef, {
                        ...tag,
                        createdAt: serverTimestamp()
                    }));
                    await Promise.all(batchPromises);
                }
            }
        };

        // 發送事件通知
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const Trash2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const XCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const AlertCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const Trophy = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2h-4a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4h4a4 4 0 0 0 4-4V6a4 4 0 0 0-4-4Z"/></svg>;
        const User = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const UserCheck = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>;
        const Coins = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg>;
        const CloudOff = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/></svg>;

        function App() {
            const CHILDREN = ["陳品希", "陳宥燊"];
            const RECORDERS = ["爸爸", "媽媽"];
            
            const [mode, setMode] = useState('punish');
            const [selectedChild, setSelectedChild] = useState(CHILDREN[0]);
            const [selectedRecorder, setSelectedRecorder] = useState(RECORDERS[0]);
            const [activeTab, setActiveTab] = useState(CHILDREN[0]);
            
            const [allRecords, setAllRecords] = useState([]);
            const [allTags, setAllTags] = useState([]); 
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentReason, setCurrentReason] = useState('');
            const [rewardAmount, setRewardAmount] = useState(10);
            
            const [isConfigured, setIsConfigured] = useState(window.dbService && window.dbService.isReady);

            const DEDUCTION_AMOUNT = 10;

            // 預設項目 (用於初始化 DB)
            const INITIAL_PRESETS = useMemo(() => ([
                { label: '頂嘴', value: 10, type: 'punish' },
                { label: '忘記關燈', value: 10, type: 'punish' },
                { label: '用餐完沒整理', value: 10, type: 'punish' },
                { label: '垃圾亂丟沒分類', value: 10, type: 'punish' },
                { label: '傍晚在家裡奔跑', value: 10, type: 'punish' },
                { label: '浴巾亂放', value: 10, type: 'punish' },
                { label: '小考95分以上', value: 20, type: 'reward' },
                { label: '小考100分', value: 100, type: 'reward' },
                { label: '大考90分以上', value: 100, type: 'reward' },
                { label: '大考100分', value: 200, type: 'reward' }
            ]), []);

            // 初始化與監聽
            useEffect(() => {
                const checkReady = () => {
                    if (window.dbService && window.dbService.isReady) {
                        setIsConfigured(true);
                        // 嘗試初始化預設標籤
                        window.dbService.seedTags(INITIAL_PRESETS);
                    }
                };
                checkReady();
                window.addEventListener('firebase-ready', checkReady);
                return () => window.removeEventListener('firebase-ready', checkReady);
            }, [INITIAL_PRESETS]);

            // 訂閱資料
            useEffect(() => {
                if (!isConfigured) return;
                const unsubRecords = window.dbService.subscribeRecords(setAllRecords);
                const unsubTags = window.dbService.subscribeTags(setAllTags);
                return () => { unsubRecords(); unsubTags(); };
            }, [isConfigured]);

            // 過濾資料
            const currentRecords = allRecords.filter(r => r.type === mode);
            const currentTags = allTags.filter(t => t.type === mode);

            const getScore = (name) => {
                return allRecords
                    .filter(r => r.child === name && r.type === mode)
                    .reduce((acc, curr) => acc + curr.amount, 0);
            };

            const handleAddRecord = () => {
                if (!currentReason.trim()) return;
                if (!isConfigured) {
                    alert("請先設定 Firebase Config");
                    return;
                }

                const amount = mode === 'punish' ? DEDUCTION_AMOUNT : parseInt(rewardAmount);

                // 1. 新增紀錄
                window.dbService.addRecord({
                    habit: currentReason,
                    child: selectedChild,
                    recorder: selectedRecorder,
                    amount: amount,
                    type: mode,
                });

                // 2. 自動儲存新標籤 (如果該標籤不存在於 DB 中)
                const exists = currentTags.some(t => t.label === currentReason);
                if (!exists) {
                    window.dbService.addTag({
                        label: currentReason,
                        value: amount,
                        type: mode
                    });
                }

                setCurrentReason('');
                setRewardAmount(10);
                setIsModalOpen(false);
                setActiveTab(selectedChild);
            };

            const handleDeleteRecord = (id) => {
                window.dbService.deleteRecord(id);
            };
            
            const handleDeleteTag = (e, id) => {
                e.stopPropagation(); // 避免觸發按鈕點擊
                window.dbService.deleteTag(id);
            };

            const handleTagClick = (tag) => {
                setCurrentReason(tag.label);
                if (mode === 'reward') {
                    setRewardAmount(tag.value || 10);
                }
            };

            const displayRecords = currentRecords.filter(r => r.child === activeTab);

            // Theme Config
            const theme = mode === 'punish' ? {
                bg: 'bg-slate-100',
                text: 'text-slate-800',
                primary: 'red',
                icon: AlertCircle,
                title: '壞習慣扣點',
                desc: '雲端同步・即時更新',
                addBtnBorder: 'border-red-300',
                addBtnHover: 'hover:border-red-500 hover:bg-red-50',
                addIconColor: 'text-red-500',
                scoreColor: 'text-red-400',
                cardBg: 'bg-slate-800',
                modalBtn: 'bg-red-500 hover:bg-red-600 shadow-red-500/30',
                ruleText: `規則：一次扣 ${DEDUCTION_AMOUNT} R 幣`
            } : {
                bg: 'bg-amber-50',
                text: 'text-slate-800',
                primary: 'yellow',
                icon: Trophy,
                title: '學業獎勵榜',
                desc: '雲端同步・即時更新',
                addBtnBorder: 'border-yellow-400',
                addBtnHover: 'hover:border-yellow-600 hover:bg-yellow-50',
                addIconColor: 'text-yellow-500',
                scoreColor: 'text-yellow-400',
                cardBg: 'bg-emerald-800',
                modalBtn: 'bg-yellow-500 hover:bg-yellow-600 shadow-yellow-500/30 text-white',
                ruleText: '規則：由大人自訂 R 幣金額'
            };

            const CurrentIcon = theme.icon;

            if (!isConfigured) {
                return (
                    <div className="min-h-screen bg-slate-800 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl p-8 max-w-md w-full text-center space-y-4">
                            <CloudOff className="w-16 h-16 mx-auto text-slate-400" />
                            <h2 className="text-2xl font-bold text-slate-800">連接資料庫中...</h2>
                            <p className="text-slate-600 text-left text-sm leading-relaxed">
                                系統正在連線，請稍候...
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen ${theme.bg} p-4 md:p-8 font-sans ${theme.text} transition-colors duration-300`}>
                    <div className="max-w-3xl mx-auto space-y-6 pb-20">
                        
                        {/* Header */}
                        <header className="text-center mb-6 animate-fade-in">
                            <h1 className={`text-3xl font-bold flex items-center justify-center gap-2 ${mode === 'punish' ? 'text-slate-700' : 'text-emerald-800'}`}>
                                <CurrentIcon className={`w-8 h-8 ${mode === 'punish' ? 'text-red-500' : 'text-yellow-500'}`} />
                                {theme.title}
                            </h1>
                            <p className="text-slate-500 mt-2 text-sm flex items-center justify-center gap-1">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                {theme.desc}
                            </p>
                        </header>

                        {/* Input Controls */}
                        <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-2 flex items-center gap-2">
                                        <User className="w-4 h-4" />
                                        對象 (小朋友)
                                    </label>
                                    <div className="relative">
                                        <select
                                            value={selectedChild}
                                            onChange={(e) => setSelectedChild(e.target.value)}
                                            className="w-full text-lg p-3 pr-10 border-2 border-slate-200 rounded-xl focus:border-blue-400 focus:ring-4 focus:ring-blue-100 outline-none appearance-none bg-white transition-all cursor-pointer font-bold text-slate-700"
                                        >
                                            {CHILDREN.map(name => <option key={name} value={name}>{name}</option>)}
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">▼</div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-2 flex items-center gap-2">
                                        <UserCheck className="w-4 h-4" />
                                        紀錄者 (大人)
                                    </label>
                                    <div className="flex bg-slate-100 p-1 rounded-xl">
                                        {RECORDERS.map(recorder => (
                                            <button
                                                key={recorder}
                                                onClick={() => setSelectedRecorder(recorder)}
                                                className={`flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all ${selectedRecorder === recorder ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                            >
                                                {recorder}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Action Area */}
                        <div className="grid md:grid-cols-12 gap-6">
                            <div className="md:col-span-5">
                                <button
                                    onClick={() => setIsModalOpen(true)}
                                    className={`w-full h-full min-h-[200px] group bg-white rounded-2xl p-6 shadow-sm border-2 border-dashed ${theme.addBtnBorder} ${theme.addBtnHover} transition-all cursor-pointer flex flex-col items-center justify-center text-center relative overflow-hidden`}
                                >
                                    <div className={`p-4 rounded-full mb-4 group-hover:scale-110 transition-transform relative z-10 ${mode === 'punish' ? 'bg-red-100' : 'bg-yellow-100'}`}>
                                        <Plus className={`w-10 h-10 ${theme.addIconColor}`} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-700 mb-1 relative z-10">
                                        {mode === 'punish' ? '新增扣點記錄' : '新增獎勵記錄'}
                                    </h3>
                                    <p className="text-slate-500 text-sm relative z-10">
                                        目前對象：<span className="font-bold text-slate-800">{selectedChild}</span>
                                        <br/>
                                        紀錄者：<span className="font-bold text-slate-800">{selectedRecorder}</span>
                                    </p>
                                </button>
                            </div>

                            <div className="md:col-span-7 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col min-h-[300px] overflow-hidden">
                                <div className="flex border-b border-slate-100">
                                    {CHILDREN.map(child => (
                                        <button
                                            key={child}
                                            onClick={() => setActiveTab(child)}
                                            className={`flex-1 py-3 text-sm font-bold transition-colors border-b-2 ${activeTab === child ? 'border-blue-500 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            {child} 的紀錄
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="flex-1 p-4 overflow-y-auto max-h-[300px] space-y-3 custom-scrollbar">
                                    {displayRecords.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-400 text-sm italic min-h-[150px]">
                                            {activeTab} 目前{mode === 'punish' ? '表現良好，沒有違規' : '還沒有獎勵紀錄，加油！'}
                                        </div>
                                    ) : (
                                        displayRecords.map((record) => (
                                        <div key={record.id} className="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-start group">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-bold text-slate-800 text-lg">{record.habit}</span>
                                                </div>
                                                <div className="text-xs text-slate-500 flex items-center gap-2">
                                                    <span className="bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded text-[10px]">
                                                        {record.recorder} 記錄
                                                    </span>
                                                    <span>{record.timestampStr}</span>
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-end gap-1">
                                                <span className={`font-bold text-lg ${mode === 'punish' ? 'text-red-500' : 'text-emerald-600'}`}>
                                                    {mode === 'punish' ? '-' : '+'}{record.amount}
                                                </span>
                                                <button 
                                                    onClick={() => handleDeleteRecord(record.id)}
                                                    className="text-xs text-slate-300 hover:text-red-400 transition-colors px-2 py-1"
                                                >
                                                    撤銷
                                                </button>
                                            </div>
                                        </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Stats Cards */}
                        <div className="space-y-4">
                            <div className="flex items-center gap-2 text-slate-500 font-medium px-2 text-sm">
                                <AlertCircle className="w-4 h-4" />
                                    <span>{theme.ruleText}</span>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                {CHILDREN.map((child, index) => {
                                    const score = getScore(child);
                                    const isCurrent = selectedChild === child;
                                    return (
                                        <div key={child} className={`relative rounded-2xl p-6 overflow-hidden transition-all duration-300 ${index === 0 ? theme.cardBg : (mode === 'punish' ? 'bg-slate-700' : 'bg-emerald-700')} text-white ${isCurrent ? 'ring-4 ring-offset-2 ring-blue-200' : 'opacity-90'}`}>
                                            <div className="relative z-10">
                                                <div className="text-slate-300 text-sm font-medium mb-1">
                                                    {child} {mode === 'punish' ? '目前總扣分' : '目前總獎勵'}
                                                </div>
                                                <div className="flex items-baseline gap-1">
                                                    <span className={`text-4xl md:text-5xl font-bold tracking-tight ${theme.scoreColor}`}>
                                                        {score}
                                                    </span>
                                                    <span className="text-sm text-slate-400">R 幣</span>
                                                </div>
                                            </div>
                                            <Coins className="absolute -right-4 -bottom-4 w-24 h-24 text-white/5 rotate-12" />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg px-6 py-2 flex justify-around items-center z-40 safe-area-bottom">
                        <button onClick={() => setMode('punish')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-32 ${mode === 'punish' ? 'text-red-500 bg-red-50' : 'text-slate-400 hover:text-slate-600'}`}>
                            <AlertCircle className="w-6 h-6" />
                            <span className="text-xs font-bold">壞習慣扣點</span>
                        </button>
                        <button onClick={() => setMode('reward')} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-32 ${mode === 'reward' ? 'text-yellow-600 bg-yellow-50' : 'text-slate-400 hover:text-slate-600'}`}>
                            <Trophy className="w-6 h-6" />
                            <span className="text-xs font-bold">學業獎勵</span>
                        </button>
                    </div>

                    {/* Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="mb-4 border-b pb-4 flex-shrink-0">
                                    <h3 className="text-2xl font-bold text-slate-800">{mode === 'punish' ? '新增扣點' : '新增獎勵'}</h3>
                                    <div className="mt-2 text-sm text-slate-500 flex gap-4">
                                        <span>對象：<b className="text-blue-600">{selectedChild}</b></span>
                                        <span>紀錄者：<b className="text-slate-700">{selectedRecorder}</b></span>
                                    </div>
                                </div>
                                <div className="space-y-4 flex-1 overflow-y-auto custom-scrollbar px-1">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">{mode === 'punish' ? '違規事項' : '獎勵原因'}</label>
                                        <input type="text" autoFocus 
                                            placeholder={mode === 'punish' ? "可輸入新原因，下次會自動記憶..." : "例如：數學考100分..."} 
                                            value={currentReason} 
                                            onChange={(e) => setCurrentReason(e.target.value)} 
                                            className={`w-full text-lg p-3 border-2 border-slate-200 rounded-xl outline-none focus:ring-4 transition-all ${mode === 'punish' ? 'focus:border-red-400 focus:ring-red-100' : 'focus:border-yellow-400 focus:ring-yellow-100'}`} 
                                        />
                                    </div>
                                    {mode === 'reward' && (
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">給予 R 幣金額</label>
                                            <div className="flex gap-2">
                                                <input type="number" value={rewardAmount} onChange={(e) => setRewardAmount(e.target.value)} className="flex-1 text-lg p-3 border-2 border-slate-200 rounded-xl outline-none focus:border-yellow-400 focus:ring-4 focus:ring-yellow-100" />
                                                <div className="flex gap-1">
                                                    {[10, 50, 100].map(amt => <button key={amt} onClick={() => setRewardAmount(amt)} className="px-3 bg-yellow-100 text-yellow-700 rounded-lg font-bold hover:bg-yellow-200">{amt}</button>)}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-2">快速選擇（可管理）</label>
                                        <div className="flex flex-wrap gap-2">
                                            {currentTags.map((tag) => (
                                                <div key={tag.id} 
                                                     onClick={() => handleTagClick(tag)} 
                                                     className={`group relative px-3 py-1.5 rounded-full text-sm font-medium transition-all flex items-center gap-1 cursor-pointer border ${currentReason === tag.label ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-slate-50 border-slate-200 text-slate-600 hover:border-slate-400'}`}>
                                                    
                                                    {tag.label}
                                                    {mode === 'reward' && <span className="opacity-70 text-xs">(${tag.value})</span>}
                                                    
                                                    {/* 刪除按鈕 */}
                                                    <button 
                                                        onClick={(e) => handleDeleteTag(e, tag.id)}
                                                        className="ml-1 p-0.5 rounded-full hover:bg-red-100 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        title="移除此選項"
                                                    >
                                                        <XCircle />
                                                    </button>
                                                </div>
                                            ))}
                                            {currentTags.length === 0 && (
                                                <div className="text-sm text-slate-400 italic py-2">
                                                    尚無選項，輸入並送出後會自動儲存。
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6 pt-4 border-t flex-shrink-0">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 px-4 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors">取消</button>
                                    <button onClick={handleAddRecord} disabled={!currentReason.trim()} className={`flex-1 py-3 px-4 rounded-xl font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed ${theme.modalBtn}`}>確認{mode === 'punish' ? '扣點' : '獎勵'}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
